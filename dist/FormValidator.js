!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.FormValidator=t():e.FormValidator=t()}(this,(()=>(()=>{"use strict";var e={d:(t,i)=>{for(var s in i)e.o(i,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:i[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},t={};e.d(t,{FormValidator:()=>S});const i="field:validated",s="form:validated",a="count:updated",r="submit:state-changed",n="form:reset";class l{constructor(e){this.fields=new Map,this.eventManager=e}initializeField(e,t,i,s){const a=s?s(t):this.checkFieldInHiddenArea(e),r=!a&&(t.hasAttribute("required")||t.dataset.validate&&t.dataset.validate.split(",").map((e=>e.trim())).includes("required")),n=t.value||"",l=a||!r||!!n.trim(),o={value:n,isValid:l,errors:[],isDirty:!1,isTouched:!1,...i};this.fields.set(e,o)}updateField(e,t){const i=this.fields.get(e);if(i){const s={...i,...t};this.fields.set(e,s)}}getField(e){return this.fields.get(e)}getAllStates(){const e={};for(const[t,i]of this.fields)e[t]={...i};return e}getValidFieldCount(){let e=0;for(const t of this.fields.values())t.isValid&&e++;return e}getTotalFieldCount(){return this.fields.size}get isValid(){for(const[e,t]of this.fields)if(!this.checkFieldInHiddenArea(e)&&!t.isValid)return!1;return!0}get isDirty(){for(const e of this.fields.values())if(e.isDirty)return!0;return!1}reset(){for(const[e,t]of this.fields)this.fields.set(e,{...t,value:"",isValid:!0,errors:[],isDirty:!1,isTouched:!1})}removeField(e){this.fields.delete(e)}clear(){this.fields.clear()}isFieldInHiddenArea(e){return this.checkFieldInHiddenArea(e)}checkFieldInHiddenArea(e){const t=document.querySelector(`[name='${e}'], [id='${e}']`);if(!t)return!1;if(t.hasAttribute("data-validate-hidden"))return!0;let i=t.parentElement;for(;i;){if(i.hasAttribute("data-validate-hidden"))return!0;i=i.parentElement}return!1}reevaluateFieldRequiredState(e,t){const i=document.querySelector(`[name='${e}'], [id='${e}']`);if(!i||!(i instanceof HTMLInputElement||i instanceof HTMLSelectElement||i instanceof HTMLTextAreaElement))return;const s=this.fields.get(e);if(!s)return;const a=t?t(e):this.checkFieldInHiddenArea(e),r=!a&&(i.hasAttribute("required")||i.dataset.validate&&i.dataset.validate.split(",").map((e=>e.trim())).includes("required"));let n;if(a)n=!0;else if(r){n=!!(i.value||"").trim()}else n=!0;this.fields.set(e,{...s,isValid:n,errors:n?[]:s.errors}),"undefined"!=typeof console&&console.log&&console.log(`[FieldStateManager] Reevaluated field ${e}: isInHiddenArea=${a}, isRequired=${r}, isValid=${n}`)}reevaluateAllFieldsRequiredState(e){for(const t of this.fields.keys())this.reevaluateFieldRequiredState(t,e)}getRequiredFieldIds(e){const t=[],i=[];for(const[s,a]of this.fields){if(e?e(s):this.checkFieldInHiddenArea(s)){i.push(s);continue}const a=document.querySelector(`[name='${s}'], [id='${s}']`);(a instanceof HTMLInputElement||a instanceof HTMLSelectElement||a instanceof HTMLTextAreaElement)&&(a.hasAttribute("required")||a.dataset.validate&&a.dataset.validate.split(",").map((e=>e.trim())).includes("required"))?t.push(s):a instanceof HTMLElement&&(a.hasAttribute("data-check_validate")||a.hasAttribute("data-radio_validate")||a.hasAttribute("data-select_validate"))&&t.push(s)}return"undefined"!=typeof console&&console.log&&(console.log("[FieldStateManager] Required fields:",t),console.log("[FieldStateManager] Excluded fields:",i)),t}getValidRequiredFieldCount(e){let t=0;for(const i of this.getRequiredFieldIds(e)){const e=this.fields.get(i);e&&e.isValid&&t++}return t}getTotalRequiredFieldCount(e){return this.getRequiredFieldIds(e).length}}class o{constructor(e){this.errorElements=new Map,this.options=e}showFieldError(e,t,i){if(!this.options.showOnValidation)return;this.clearField(e);const s=this.createErrorElement(t);s.id=`${e}-error`,s.setAttribute("role","alert"),s.setAttribute("aria-live","polite");const a=i.parentElement;a&&a.insertBefore(s,i.nextSibling);const r=i.getAttribute("aria-describedby");r?i.setAttribute("aria-describedby",`${r} ${s.id}`):i.setAttribute("aria-describedby",s.id),this.errorElements.set(e,s),this.animateShow(s),i.classList.add("error","invalid"),i.setAttribute("aria-invalid","true")}clearField(e){const t=this.errorElements.get(e);if(t){this.animateHide(t,(()=>{t.parentElement&&t.parentElement.removeChild(t)}));const i=document.querySelector(`[name="${e}"], [id="${e}"]`);if(i){const t=i.getAttribute("aria-describedby");if(t){const s=t.split(" ").filter((t=>t!==`${e}-error`)).join(" ");s?i.setAttribute("aria-describedby",s):i.removeAttribute("aria-describedby")}i.classList.remove("error","invalid"),i.setAttribute("aria-invalid","false")}this.errorElements.delete(e)}}clearAll(){for(const e of this.errorElements.keys())this.clearField(e)}createErrorElement(e){const t=document.createElement("div");return t.className="error-message",t.textContent=e,t.style.cssText="\n            color: #dc3545;\n            font-size: 0.875rem;\n            margin-top: 0.25rem;\n            display: block;\n        ",t}animateShow(e){this.options.animationDuration>0&&(e.style.opacity="0",e.style.transform="translateY(-10px)",e.style.transition=`opacity ${this.options.animationDuration}ms ease, transform ${this.options.animationDuration}ms ease`,requestAnimationFrame((()=>{e.style.opacity="1",e.style.transform="translateY(0)"})))}animateHide(e,t){this.options.animationDuration>0?(e.style.transition=`opacity ${this.options.animationDuration}ms ease, transform ${this.options.animationDuration}ms ease`,e.style.opacity="0",e.style.transform="translateY(-10px)",setTimeout(t,this.options.animationDuration)):t()}hasError(e){return this.errorElements.has(e)}getErrorCount(){return this.errorElements.size}}class d{constructor(){this.next=null}setNext(e){return this.next=e,e}async handleNext(e,t){if(this.next){return await this.next.validate(e,t)}return{isValid:!0,errors:[]}}combineResults(e,t){return{isValid:e.isValid&&t.isValid,errors:[...e.errors,...t.errors]}}isEmpty(e){return null===e||(void 0===e||("string"==typeof e?""===e.trim():Array.isArray(e)?0===e.length:"object"==typeof e&&0===Object.keys(e).length))}convertToString(e,t,i,s){if("string"==typeof e)return{success:!0,value:e};if("number"==typeof e)return{success:!0,value:String(e)};{const a=this.createErrorMessage(t,i,s);return{success:!1,result:this.createFailureResult([this.createError(t,a,e)])}}}createErrorMessage(e,t,i){return i?.message?i.message:t}createError(e,t,i){return{rule:e,message:t,value:i}}createSuccessResult(){return{isValid:!0,errors:[]}}createFailureResult(e){return{isValid:!1,errors:e}}}class u extends d{constructor(){super(...arguments),this.defaultMessages={default:"この項目は入力必須です。",name:"お名前を入力してください。",furiganaHira:"ふりがなを入力してください。",furiganaKana:"フリガナを入力してください。",postalCode:"郵便番号を入力してください。",postal:"住所を入力してください。",tel:"電話番号を入力してください。",email:"メールアドレスを入力してください。",emailConf:"確認用メールアドレスを入力してください。",password:"パスワードを入力してください。",text:"お問い合わせ内容を入力してください。",checkbox:"チェックボックスを選択してください。",radiobox:"ラジオボタンを選択してください。",agree:"個人情報保護方針の同意にチェックを入れてください。",select:"選択してください。"}}async validate(e,t){if(this.isEmpty(e)){const i=this.determineErrorMessage(t);return this.createFailureResult([this.createError("required",i,e)])}return await this.handleNext(e,t)}determineErrorMessage(e){if(e?.message)return e.message;if(e?.customMessageKey&&e?.customMessages?.[e.customMessageKey])return e.customMessages[e.customMessageKey];if(e?.fieldType){const t=e.fieldType;if(t in this.defaultMessages)return this.defaultMessages[t]}if(e?.validationTypes){const t=e.validationTypes;if(t.includes("name"))return this.defaultMessages.name;if(t.includes("furigana")){if(t.includes("hiragana"))return this.defaultMessages.furiganaHira;if(t.includes("katakana"))return this.defaultMessages.furiganaKana}if(t.includes("postal-code"))return this.defaultMessages.postalCode;if(t.includes("postal"))return this.defaultMessages.postal;if(t.includes("tel"))return this.defaultMessages.tel;if(t.includes("email-conf"))return this.defaultMessages.emailConf;if(t.includes("email"))return this.defaultMessages.email;if(t.includes("password"))return this.defaultMessages.password;if(t.includes("text"))return this.defaultMessages.text;if(t.includes("agree"))return this.defaultMessages.agree}return"checkbox"===e?.elementType?this.defaultMessages.checkbox:"radio"===e?.elementType?this.defaultMessages.radiobox:"select"===e?.elementType?this.defaultMessages.select:this.defaultMessages.default}}class c extends d{constructor(){super(...arguments),this.emailPattern=/^([a-zA-Z0-9])+([a-zA-Z0-9\._-])*@([a-zA-Z0-9_-])+([a-zA-Z0-9\._-]+)+$/,this.defaultMessage="メールアドレスの形式が正しくありません。"}async validate(e,t){if(this.isEmpty(e))return await this.handleNext(e,t);const i=this.convertToString(e,"email",this.defaultMessage,t);if(!i.success)return i.result;const s=i.value;if(!this.emailPattern.test(s)){const i=this.createErrorMessage("email",this.defaultMessage,t);return this.createFailureResult([this.createError("email",i,e)])}if(t?.checkConfirmation){const i=t.confirmationValue;if(i&&s!==i){const i=t.mismatchMessage||"メールアドレスが一致しません。";return this.createFailureResult([this.createError("email-mismatch",i,e)])}}return await this.handleNext(s,t)}}class h extends d{constructor(){super(...arguments),this.defaultMessage="メールアドレスが一致しません。"}async validate(e,t){if(this.isEmpty(e))return await this.handleNext(e,t);const i=this.convertToString(e,"email-conf",this.defaultMessage,t);if(!i.success)return i.result;const s=i.value,a=t?.originalEmail;if(a){if(s!==a){const i=this.createErrorMessage("email-conf",this.defaultMessage,t);return this.createFailureResult([this.createError("email-conf",i,e)])}}else{const i=document.querySelector('input[data-validate*="email"]:not([data-validate*="email-conf"])');if(i){if(s!==i.value){const i=this.createErrorMessage("email-conf",this.defaultMessage,t);return this.createFailureResult([this.createError("email-conf",i,e)])}}}return await this.handleNext(s,t)}}class f extends d{constructor(){super(...arguments),this.patterns={telWithHyphens:/^0(((\d{1}-\d{4}|\d{2}-\d{3,4}|\d{3}-\d{2,3}|\d{4}-\d{1})-\d{4})|\d{3}-\d{3}-\d{3})$/,telWithoutHyphens:/^0\d{9,10}$/,halfWidth:/^[0-9\-]+$/},this.defaultMessages={default:"電話番号の形式が正しくありません。",withHyphens:"電話番号はハイフン付きの形式で入力してください。",withoutHyphens:"電話番号はハイフンなしの形式で入力してください。",halfWidth:"半角数字で入力してください。"}}async validate(e,t){if(this.isEmpty(e))return await this.handleNext(e,t);const i=this.convertToString(e,"tel",this.defaultMessages.default,t);if(!i.success)return i.result;const s=i.value,a=this.normalizeNumber(s);if(!this.patterns.halfWidth.test(a)){const i=this.createErrorMessage("tel-halfwidth",this.defaultMessages.halfWidth,t);return this.createFailureResult([this.createError("tel-halfwidth",i,e)])}const r=t?.allowHyphens??null;let n=!1,l=this.defaultMessages.default;if(!0===r?(n=this.patterns.telWithHyphens.test(a),l=this.defaultMessages.withHyphens):!1===r?(n=this.patterns.telWithoutHyphens.test(a),l=this.defaultMessages.withoutHyphens):n=this.patterns.telWithHyphens.test(a)||this.patterns.telWithoutHyphens.test(a),!n){const i=this.createErrorMessage("tel",l,t);return this.createFailureResult([this.createError("tel",i,e)])}return await this.handleNext(a,t)}normalizeNumber(e){return e.replace(/[０-９]/g,(e=>String.fromCharCode(e.charCodeAt(0)-65248))).replace(/[ー－]/g,"-")}}class m extends d{constructor(){super(...arguments),this.patterns={postalCodeWithHyphens:/^\d{3}-\d{4}$/,postalCodeWithoutHyphens:/^\d{7}$/,halfWidth:/^[0-9\-]+$/},this.defaultMessages={default:"郵便番号の形式が正しくありません。",withHyphens:"郵便番号はハイフン付きの形式で入力してください。",withoutHyphens:"郵便番号はハイフンなしの形式で入力してください。",halfWidth:"半角数字で入力してください。"}}async validate(e,t){if(this.isEmpty(e))return await this.handleNext(e,t);const i=this.convertToString(e,"postal-code",this.defaultMessages.default,t);if(!i.success)return i.result;const s=i.value,a=this.normalizeNumber(s);if(!this.patterns.halfWidth.test(a)){const i=this.createErrorMessage("postal-code-halfwidth",this.defaultMessages.halfWidth,t);return this.createFailureResult([this.createError("postal-code-halfwidth",i,e)])}const r=t?.allowHyphens??null;let n=!1,l=this.defaultMessages.default;if(!0===r?(n=this.patterns.postalCodeWithHyphens.test(a),l=this.defaultMessages.withHyphens):!1===r?(n=this.patterns.postalCodeWithoutHyphens.test(a),l=this.defaultMessages.withoutHyphens):n=this.patterns.postalCodeWithHyphens.test(a)||this.patterns.postalCodeWithoutHyphens.test(a),!n){const i=this.createErrorMessage("postal-code",l,t);return this.createFailureResult([this.createError("postal-code",i,e)])}return t?.usePostalCodeJS&&t?.onValidPostalCode&&t.onValidPostalCode(a),await this.handleNext(a,t)}normalizeNumber(e){return e.replace(/[０-９]/g,(e=>String.fromCharCode(e.charCodeAt(0)-65248))).replace(/[ー－]/g,"-")}}class g extends d{constructor(){super(...arguments),this.patterns={number:/^[0-9０-９]+$/,hiragana:/^[ぁ-んー　 ]+$/,katakana:/^[ァ-ヶー　 ]+$/,halfWidth:/^[0-9]+$/,password:/^(?=.*?[a-z])(?=.*?\d)[a-z\d]{8,16}$/i},this.defaultMessages={number:"数字で入力してください。",hiragana:"全角ひらがなで入力してください。",katakana:"全角カタカナで入力してください。",halfWidth:"半角数字で入力してください。",password:"半角英数字をそれぞれ含む8文字以上16文字以下で入力してください。"}}async validate(e,t){if(this.isEmpty(e))return await this.handleNext(e,t);const i=this.convertToString(e,"text","文字列を入力してください。",t);if(!i.success)return i.result;const s=i.value,a=t?.textType||t?.validationType;if(!a)return await this.handleNext(s,t);switch(a){case"number":if(t?.validationTypes&&t.validationTypes.includes("halfWidth")){const t=this.normalizeNumber(s);if(!this.patterns.halfWidth.test(t)){const t=this.defaultMessages.halfWidth;return this.createFailureResult([this.createError("halfwidth",t,e)])}if(!this.patterns.number.test(t)){const t=this.defaultMessages.number;return this.createFailureResult([this.createError("number",t,e)])}}else if(!this.patterns.number.test(s)){const t=this.defaultMessages.number;return this.createFailureResult([this.createError("number",t,e)])}break;case"halfWidth":if(!this.patterns.halfWidth.test(s)){const i=this.createErrorMessage("halfwidth",this.defaultMessages.halfWidth,t);return this.createFailureResult([this.createError("halfwidth",i,e)])}break;case"hiragana":if(!this.patterns.hiragana.test(s)){const i=this.createErrorMessage("hiragana",this.defaultMessages.hiragana,t);return this.createFailureResult([this.createError("hiragana",i,e)])}break;case"katakana":if(!this.patterns.katakana.test(s)){const i=this.createErrorMessage("katakana",this.defaultMessages.katakana,t);return this.createFailureResult([this.createError("katakana",i,e)])}break;case"password":if(!this.patterns.password.test(s)){const i=this.createErrorMessage("password",this.defaultMessages.password,t);return this.createFailureResult([this.createError("password",i,e)])}}return await this.handleNext(s,t)}normalizeNumber(e){return e.replace(/[０-９]/g,(e=>String.fromCharCode(e.charCodeAt(0)-65248))).replace(/[ー－]/g,"-")}}class p extends d{constructor(e,t="カスタムバリデーションエラー"){super(),this.customValidationFunction=e,this.customErrorMessage=t}async validate(e,t){try{if(!await this.customValidationFunction(e,t)){const i=this.createErrorMessage("custom",this.customErrorMessage,t);return this.createFailureResult([this.createError("custom",i,e)])}return await this.handleNext(e,t)}catch(i){const s=t?.message||`バリデーションエラー: ${i}`;return this.createFailureResult([this.createError("custom-error",s,e)])}}}class v{constructor(){this.validators=new Map,this.validatorFactories=new Map,this.registerDefaultValidators()}registerDefaultValidators(){this.registerValidatorFactory("required",(()=>new u)),this.registerValidatorFactory("email",(()=>new c)),this.registerValidatorFactory("email-conf",(()=>new h)),this.registerValidatorFactory("tel",(()=>new f)),this.registerValidatorFactory("postal-code",(()=>new m)),this.registerValidatorFactory("number",(()=>new g)),this.registerValidatorFactory("hiragana",(()=>new g)),this.registerValidatorFactory("katakana",(()=>new g)),this.registerValidatorFactory("password",(()=>new g)),this.registerValidatorFactory("halfWidth",(()=>new g))}registerValidatorFactory(e,t){this.validatorFactories.set(e,t)}registerCustomValidator(e,t,i){this.registerValidatorFactory(e,(()=>new p(t,i)))}buildValidatorChain(e,t){if(0===e.length)return null;const i=[];for(const s of e){if(s.startsWith("emesse")){t&&(t.customMessageKey=s);continue}const e=this.validatorFactories.get(s);if(e){const t=e();i.push(t)}}if(0===i.length)return null;for(let e=0;e<i.length-1;e++)i[e].setNext(i[e+1]);return i[0]}async validate(e,t,i){let s="string"==typeof t?t.split(",").map((e=>e.trim())):[...t],a=e;if(s.includes("replace")&&"string"==typeof e){let t=e.replace(/[０-９]/g,(e=>String.fromCharCode(e.charCodeAt(0)-65248))).replace(/[ー－—―]/g,"-");e=t,s=s.filter((e=>"replace"!==e))}const r={...i,validationTypes:s};if(s.includes("number")||s.includes("hiragana")||s.includes("katakana")||s.includes("password")||s.includes("halfWidth")){const e=s.find((e=>["number","hiragana","katakana","password","halfWidth"].includes(e)));e&&(r.textType=e)}const n=this.buildValidatorChain(s,r);if(!n)return{isValid:!0,errors:[]};try{return await n.validate(a,r)}catch(t){return{isValid:!1,errors:[{rule:"validation-error",message:`バリデーションエラー: ${t}`,value:e}]}}}getRulesFromElement(e){const t=[];return e.dataset.validate&&t.push(...e.dataset.validate.split(",").map((e=>e.trim()))),e instanceof HTMLInputElement&&e.required&&!t.includes("required")&&t.push("required"),t}getElementValue(e){return e instanceof HTMLInputElement?"checkbox"===e.type?e.checked:"radio"===e.type?e.checked?e.value:"":e.value:e instanceof HTMLSelectElement||e instanceof HTMLTextAreaElement?e.value:""}async validateElement(e,t){const i=this.getRulesFromElement(e);let s=this.getElementValue(e);if(i.includes("replace")&&"string"==typeof s){let t=s.replace(/[０-９]/g,(e=>String.fromCharCode(e.charCodeAt(0)-65248))).replace(/[ー－—―]/g,"-");s=t,(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement)&&(e.value=t)}const a={...t,elementType:e.tagName.toLowerCase()};return e instanceof HTMLInputElement&&(a.elementType=e.type),this.validate(s,i,a)}}class y{constructor(e){this.validator=new v,this.options=e}async validateField(e,t,i={}){return await this.validator.validateElement(e,{customMessages:i})}async validateInputField(e,t,i,s){const a=e.type;switch(a){case"email":t&&!this.isValidEmail(t)&&i.push({rule:"email",message:s.email||"有効なメールアドレスを入力してください",value:t});break;case"url":t&&!this.isValidUrl(t)&&i.push({rule:"url",message:s.url||"有効なURLを入力してください",value:t});break;case"tel":t&&!this.isValidPhone(t)&&i.push({rule:"tel",message:s.tel||"有効な電話番号を入力してください",value:t});break;case"number":t&&!this.isValidNumber(t)&&i.push({rule:"number",message:s.number||"有効な数値を入力してください",value:t})}if(e.minLength>0&&t.length<e.minLength&&i.push({rule:"minlength",message:s.minlength||`${e.minLength}文字以上で入力してください`,value:t}),e.maxLength>0&&t.length>e.maxLength&&i.push({rule:"maxlength",message:s.maxlength||`${e.maxLength}文字以下で入力してください`,value:t}),"number"===a&&t){const a=parseFloat(t);isNaN(a)||(e.min&&a<parseFloat(e.min)&&i.push({rule:"min",message:s.min||`${e.min}以上の値を入力してください`,value:t}),e.max&&a>parseFloat(e.max)&&i.push({rule:"max",message:s.max||`${e.max}以下の値を入力してください`,value:t}))}if(e.pattern&&t){new RegExp(e.pattern).test(t)||i.push({rule:"pattern",message:s.pattern||"入力形式が正しくありません",value:t})}}validateSelectField(e,t,i,s){}validateTextareaField(e,t,i,s){e.minLength>0&&t.length<e.minLength&&i.push({rule:"minlength",message:s.minlength||`${e.minLength}文字以上で入力してください`,value:t}),e.maxLength>0&&t.length>e.maxLength&&i.push({rule:"maxlength",message:s.maxlength||`${e.maxLength}文字以下で入力してください`,value:t})}isValidEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}isValidUrl(e){try{return new URL(e),!0}catch{return!1}}isValidPhone(e){return/^[\d\-\(\)\+\s]+$/.test(e)&&e.replace(/\D/g,"").length>=10}isValidNumber(e){return!isNaN(parseFloat(e))&&isFinite(parseFloat(e))}}class b{initialize(e){this.form=e,this.setupAriaLiveRegion(),this.enhanceFormAccessibility()}setupAriaLiveRegion(){if(!this.form)return;let e=this.form.querySelector("[aria-live]");e||(e=document.createElement("div"),e.setAttribute("aria-live","polite"),e.setAttribute("aria-atomic","true"),e.className="sr-only",e.style.cssText="\n                position: absolute;\n                width: 1px;\n                height: 1px;\n                padding: 0;\n                margin: -1px;\n                overflow: hidden;\n                clip: rect(0, 0, 0, 0);\n                white-space: nowrap;\n                border: 0;\n            ",this.form.appendChild(e)),this.ariaLiveRegion=e}enhanceFormAccessibility(){if(!this.form)return;this.form.hasAttribute("role")||this.form.setAttribute("role","form");this.form.querySelectorAll("[required]").forEach((e=>{e.hasAttribute("aria-required")||e.setAttribute("aria-required","true")})),this.enhanceLabeling(),this.enhanceFieldsets()}enhanceLabeling(){if(!this.form)return;this.form.querySelectorAll("input, select, textarea").forEach((e=>{if(e instanceof HTMLElement){const t=e.id,i=e.name;!t&&i&&(e.id=`field-${i}`);let s=this.form.querySelector(`label[for="${e.id}"]`);if(!s&&i&&(s=this.form.querySelector(`label[for="${i}"]`),s&&s.setAttribute("for",e.id)),!s){const t=e.closest("label");t&&(s=t)}s&&!e.hasAttribute("aria-labelledby")&&(s.id||(s.id=`label-${e.id}`),e.setAttribute("aria-labelledby",s.id))}}))}enhanceFieldsets(){if(!this.form)return;this.form.querySelectorAll("fieldset").forEach((e=>{const t=e.querySelector("legend");t&&!e.hasAttribute("aria-labelledby")&&(t.id||(t.id=`legend-${Date.now()}-${Math.random().toString(36).substr(2,9)}`),e.setAttribute("aria-labelledby",t.id))}))}announceStatus(e){this.ariaLiveRegion&&(this.ariaLiveRegion.textContent=e,setTimeout((()=>{this.ariaLiveRegion&&(this.ariaLiveRegion.textContent="")}),1e3))}announceError(e){this.announceStatus(`エラー: ${e}`)}announceSuccess(e){this.announceStatus(`成功: ${e}`)}focusField(e){if(!this.form)return;const t=this.form.querySelector(`#${e}, [name="${e}"]`);t&&"function"==typeof t.focus&&t.focus()}focusFirstError(){if(!this.form)return;const e=this.form.querySelector('[aria-invalid="true"], .error');e&&"function"==typeof e.focus&&e.focus()}cleanup(){this.ariaLiveRegion&&this.ariaLiveRegion.parentElement&&this.ariaLiveRegion.parentElement.removeChild(this.ariaLiveRegion),this.ariaLiveRegion=void 0,this.form=void 0}enhanceKeyboardNavigation(){if(!this.form)return;this.form.querySelectorAll('input, select, textarea, button, [tabindex]:not([tabindex="-1"])').forEach(((e,t)=>{e instanceof HTMLElement&&!e.hasAttribute("tabindex")&&e.setAttribute("tabindex","0")}))}enhanceVisualAccessibility(){if(!this.form)return;this.form.querySelectorAll('[aria-invalid="true"], .error').forEach((e=>{e instanceof HTMLElement&&e.classList.add("accessibility-error")}))}}class F{static querySelector(e,t=document){try{return t.querySelector(e)}catch(t){return console.error(`Invalid selector: ${e}`,t),null}}static querySelectorAll(e,t=document){try{return Array.from(t.querySelectorAll(e))}catch(t){return console.error(`Invalid selector: ${e}`,t),[]}}static getValue(e){return e instanceof HTMLInputElement?"checkbox"===e.type||"radio"===e.type?e.checked:e.value:e instanceof HTMLSelectElement||e instanceof HTMLTextAreaElement?e.value:e.textContent||""}static setValue(e,t){e instanceof HTMLInputElement?"checkbox"===e.type||"radio"===e.type?e.checked=Boolean(t):e.value=String(t):e instanceof HTMLSelectElement||e instanceof HTMLTextAreaElement?e.value=String(t):e.textContent=String(t)}static addEventListener(e,t,i,s){return e.addEventListener(t,i,s),()=>{e.removeEventListener(t,i,s)}}static addEventListeners(e,t,i,s){const a=t.map((t=>this.addEventListener(e,t,i,s)));return()=>{a.forEach((e=>e()))}}static isVisible(e){if(!e)return!1;if("none"===getComputedStyle(e).display)return!1;if("hidden"===getComputedStyle(e).visibility)return!1;if("0"===getComputedStyle(e).opacity)return!1;const t=e.getBoundingClientRect();return 0!==t.width&&0!==t.height}static isDisabled(e){return"disabled"in e?e.disabled:"true"===e.getAttribute("aria-disabled")}static focus(e,t){e&&"function"==typeof e.focus&&e.focus(t)}static closest(e,t){try{return e.closest(t)}catch(e){return console.error(`Invalid selector: ${t}`,e),null}}static contains(e,t){return e.contains(t)}static getAttribute(e,t){return e.getAttribute(t)}static setAttribute(e,t,i){e.setAttribute(t,i)}static removeAttribute(e,t){e.removeAttribute(t)}static getDataAttribute(e,t){return e.dataset[t]}static setDataAttribute(e,t,i){e.dataset[t]=i}static addClass(e,...t){e.classList.add(...t)}static removeClass(e,...t){e.classList.remove(...t)}static hasClass(e,t){return e.classList.contains(t)}static toggleClass(e,t,i){return e.classList.toggle(t,i)}static createElement(e,t){const i=document.createElement(e);return t&&(t.id&&(i.id=t.id),t.className&&(i.className=t.className),t.attributes&&Object.entries(t.attributes).forEach((([e,t])=>{i.setAttribute(e,t)})),t.text&&(i.textContent=t.text),t.html&&(i.innerHTML=t.html)),i}static scrollIntoView(e,t){e.scrollIntoView(t??{behavior:"smooth",block:"center"})}static getFormFields(e){const t=[],i=e.elements;for(let e=0;e<i.length;e++){const s=i[e];(s instanceof HTMLInputElement||s instanceof HTMLSelectElement||s instanceof HTMLTextAreaElement)&&t.push(s)}return t}static getCheckboxGroupValue(e){return this.querySelectorAll('input[type="checkbox"]:checked',e).map((e=>e.value))}static getRadioGroupValue(e){const t=this.querySelector('input[type="radio"]:checked',e);return t?t.value:null}}class E{constructor(e=300){this.timeouts=new Map,this.defaultDelay=e}debounce(e,t,i){this.cancel(e);const s=setTimeout((()=>{t(),this.timeouts.delete(e)}),i??this.defaultDelay);this.timeouts.set(e,s)}async debounceAsync(e,t,i){return new Promise(((s,a)=>{this.debounce(e,(async()=>{try{const e=await t();s(e)}catch(e){a(e)}}),i)}))}cancel(e){const t=this.timeouts.get(e);t&&(clearTimeout(t),this.timeouts.delete(e))}cancelAll(){for(const e of this.timeouts.values())clearTimeout(e);this.timeouts.clear()}isPending(e){return this.timeouts.has(e)}getPendingCount(){return this.timeouts.size}}class A{constructor(){this.listeners=new Map}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}off(e,t){const i=this.listeners.get(e);if(i){const s=i.indexOf(t);s>-1&&i.splice(s,1),0===i.length&&this.listeners.delete(e)}}emit(e,t){const i=this.listeners.get(e);i&&i.forEach((i=>{try{i(t)}catch(t){console.error(`Error in event handler for ${e}:`,t)}}))}removeAllListeners(e){e?this.listeners.delete(e):this.listeners.clear()}hasListeners(e){const t=this.listeners.get(e);return!!t&&t.length>0}getEventNames(){return Array.from(this.listeners.keys())}}class M{constructor(e,t={}){this.fieldCleanups=new Map,this.elementToIdMap=new WeakMap,this.isInitialized=!1,this.debug=!1,this.form=e,this.options=this.mergeOptions(t),this.debug=!!t.debug,this.eventManager=new A,this.fieldStates=new l(this.eventManager),this.errorDisplay=new o(this.options.errorDisplay),this.validationEngine=new y(this.options.validation),this.accessibility=new b,this.debouncer=new E,this.log("FormManager constructor called"),this.initialize()}log(e,...t){this.debug&&console.log(`[FormManager] ${e}`,...t)}mergeOptions(e){const t={...M.DEFAULT_OPTIONS,...e,customMessages:e.customMessages||{},onFieldValidated:e.onFieldValidated,onFormValidated:e.onFormValidated,onSubmitStateChanged:e.onSubmitStateChanged};return this.log("Options merged:",t),t}initialize(){this.isInitialized?this.log("Already initialized, skipping"):(this.log("Starting initialization"),this.submitButton=this.form.querySelector('button[type="submit"]')||void 0,this.log("Submit button found:",!!this.submitButton),this.setupFormFields(),this.setupEventListeners(),this.registerCustomValidators(),this.setupCallbacks(),this.accessibility.initialize(this.form),this.isInitialized=!0,this.log("Initialization completed"),setTimeout((()=>this.updateCount()),0))}setupFormFields(){const e=this.form.querySelectorAll("input, select, textarea");this.log(`Found ${e.length} form fields`),e.forEach(((e,t)=>{if(e instanceof HTMLInputElement||e instanceof HTMLSelectElement||e instanceof HTMLTextAreaElement){const i=e.name||e.id;if(!i)return void this.log(`Field ${t} has no name or id, skipping`,e);this.log(`Setting up field: ${i}`,e),this.elementToIdMap.set(e,i),this.fieldStates.initializeField(i,e,void 0,(e=>this.isFieldInHiddenAreaInternal(e))),this.setupFieldValidation(e,i)}}));[{attr:"data-check_validate",type:"checkbox"},{attr:"data-radio_validate",type:"radio"},{attr:"data-select_validate",type:"select"}].forEach((({attr:e,type:t})=>{this.form.querySelectorAll(`[${e}]`).forEach(((i,s)=>{const a=i.getAttribute("name")||i.getAttribute("id")||`${t}_group_${s}`;let r;r="select"===t?i.querySelectorAll("select"):i.querySelectorAll(`input[type=${t}]`),this.setupGroupValidation(i,r,a,e)}))}))}setupFieldValidation(e,t){const i=[];if(this.log(`Setting up validation for field: ${t}`),this.options.validation.validateOnInput){this.log(`Adding input listener for field: ${t}`);const s=F.addEventListener(e,"input",(i=>{this.log(`Input event triggered for field: ${t}`,i),this.debouncer.debounce(`validate-${t}`,(()=>{this.log(`Debounced validation triggered for field: ${t}`),this.validateField(e,t)}),this.options.validation.debounceDelay)}));i.push(s)}if(this.options.validation.validateOnBlur){this.log(`Adding blur listener for field: ${t}`);const s=F.addEventListener(e,"blur",(i=>{this.log(`Blur event triggered for field: ${t}`,i),this.validateField(e,t)}));i.push(s)}if(this.options.errorDisplay.clearOnFocus){this.log(`Adding focus listener for field: ${t}`);const s=F.addEventListener(e,"focus",(e=>{this.log(`Focus event triggered for field: ${t}`,e),this.errorDisplay.clearField(t)}));i.push(s)}this.fieldCleanups.set(t,(()=>{i.forEach((e=>e()))})),this.log(`Validation setup completed for field: ${t}`)}async validateField(e,t){const s=e.value;if(this.log(`Validating field: ${t} with value:`,s),this.isFieldInHiddenAreaInternal(e))return this.log(`Skipping validation for field in hidden area: ${t}`),this.fieldStates.updateField(t,{value:s,isValid:!0,errors:[],isDirty:!0}),this.errorDisplay.clearField(t),void this.updateCount();try{const a=await this.validationEngine.validateField(e,s,this.options.customMessages);this.log(`Validation result for ${t}:`,a),this.fieldStates.updateField(t,{value:s,isValid:a.isValid,errors:a.errors,isDirty:!0}),this.options.errorDisplay.showOnValidation&&(a.isValid?(this.log(`Clearing error for field: ${t}`),this.errorDisplay.clearField(t)):(this.log(`Showing error for field: ${t}`,a.errors[0].message),this.errorDisplay.showFieldError(t,a.errors[0].message,e))),this.eventManager.emit(i,{fieldId:t,field:e,isValid:a.isValid,errors:a.errors.map((e=>e.message))}),this.updateCount()}catch(e){this.log(`Error during validation for field ${t}:`,e)}}updateCount(){const e=e=>{const t=document.querySelector(`[name='${e}'], [id='${e}']`);return!!t&&this.isFieldInHiddenAreaInternal(t)},t=this.fieldStates.getValidRequiredFieldCount(e),i=this.fieldStates.getTotalRequiredFieldCount(e);if(this.log(`Count updated - valid: ${t}, total: ${i}`),this.log("Required field IDs:",this.fieldStates.getRequiredFieldIds(e)),this.eventManager.emit(a,{valid:t,total:i,isComplete:t===i}),this.submitButton&&this.options.disableSubmitUntilValid){const e=t===i&&this.fieldStates.isValid;this.submitButton.disabled=!e,this.log(`Submit button disabled: ${this.submitButton.disabled}, formValid: ${e}`)}}setupEventListeners(){this.log("Setting up form event listeners"),F.addEventListener(this.form,"submit",(e=>{this.log("Form submit event triggered, isValid:",this.isValid),this.isValid||(e.preventDefault(),this.log("Form submission prevented, validating all fields"),this.validateAllFieldsInternal())})),F.addEventListener(this.form,"reset",(()=>{this.log("Form reset event triggered"),this.reset()}))}async validateAllFieldsInternal(){this.log("Validating all fields (internal)");const e=this.form.querySelectorAll("input, select, textarea"),t=[];e.forEach((e=>{if(e instanceof HTMLInputElement||e instanceof HTMLSelectElement||e instanceof HTMLTextAreaElement){const i=this.elementToIdMap.get(e);i&&t.push(this.validateField(e,i))}})),await Promise.all(t),this.eventManager.emit(s,{form:this.form,isValid:this.isValid,fieldStates:this.fieldStates.getAllStates()}),this.log("All fields validation completed, isValid:",this.isValid)}registerCustomValidators(){this.log("Registering custom validators"),Object.entries(this.options.customMessages).forEach((([e,t])=>{e.startsWith("emesse")}))}setupCallbacks(){this.log("Setting up callbacks"),this.options.onFieldValidated&&this.eventManager.on(i,this.options.onFieldValidated),this.options.onFormValidated&&this.eventManager.on(s,this.options.onFormValidated),this.options.onCountUpdated&&this.eventManager.on(a,this.options.onCountUpdated),this.options.onSubmitStateChanged&&this.eventManager.on(r,this.options.onSubmitStateChanged)}reset(){this.log("Resetting form"),this.fieldStates.reset(),this.errorDisplay.clearAll(),this.updateCount(),this.eventManager.emit(n,{form:this.form})}destroy(){this.log("Destroying FormManager"),this.fieldCleanups.forEach((e=>e())),this.fieldCleanups.clear(),this.debouncer.cancelAll(),this.eventManager.removeAllListeners(),this.accessibility.cleanup(),this.elementToIdMap=new WeakMap,this.isInitialized=!1}on(e,t){this.eventManager.on(e,t)}off(e,t){this.eventManager.off(e,t)}getFieldState(e){return this.fieldStates.getField(e)}getFieldIdFromElement(e){return this.elementToIdMap.get(e)}get isValid(){return this.fieldStates.isValid}get isDirty(){return this.fieldStates.isDirty}getDebugInfo(){return{isInitialized:this.isInitialized,fieldCount:this.fieldCleanups.size,isValid:this.isValid,isDirty:this.isDirty,options:this.options,fieldStates:this.fieldStates.getAllStates()}}async validate(){this.log("Manual validation triggered"),await this.validateAllFieldsInternal()}async validateAllFields(){this.log("Validating all fields (comprehensive)");const e=this.form.querySelectorAll("input, select, textarea"),t=[];e.forEach((e=>{if(e instanceof HTMLInputElement||e instanceof HTMLSelectElement||e instanceof HTMLTextAreaElement){const i=this.elementToIdMap.get(e);if(i){const s=e.hasAttribute("required")||e.dataset.validate&&e.dataset.validate.includes("required"),a=e.value&&e.value.trim();(s||a)&&t.push(this.validateField(e,i))}}})),await Promise.all(t),this.validateAllGroupFields(),this.eventManager.emit(s,{form:this.form,isValid:this.isValid,fieldStates:this.fieldStates.getAllStates()}),this.log("All fields validation completed, isValid:",this.isValid)}updateValidationCount(){this.log("Manual count update triggered"),this.fieldStates.reevaluateAllFieldsRequiredState((e=>{const t=document.querySelector(`[name='${e}'], [id='${e}']`);return!!t&&this.isFieldInHiddenAreaInternal(t)})),this.clearHiddenAreaErrors(),this.reevaluateGroupValidations(),this.updateCount()}isFieldInHiddenArea(e){if(e.hasAttribute("data-validate-hidden"))return!0;let t=e.parentElement;for(;t&&t!==document.body;){if(t.hasAttribute("data-validate-hidden"))return!0;t=t.parentElement}return!1}isFieldInHiddenAreaInternal(e){return this.isFieldInHiddenArea(e)}clearHiddenAreaErrors(){const e=this.fieldStates.getAllStates();for(const t in e){const e=document.querySelector(`[name='${t}'], [id='${t}']`);e&&this.isFieldInHiddenAreaInternal(e)&&(this.fieldStates.updateField(t,{isValid:!0,errors:[]}),this.errorDisplay.clearField(t),this.log(`Cleared error for hidden field: ${t}`))}}validateAllGroupFields(){[{attr:"data-check_validate",type:"checkbox"},{attr:"data-radio_validate",type:"radio"},{attr:"data-select_validate",type:"select"}].forEach((({attr:e,type:t})=>{this.form.querySelectorAll(`[${e}]`).forEach(((i,s)=>{const a=i.getAttribute("name")||i.getAttribute("id")||`${t}_group_${s}`;let r;r="select"===t?i.querySelectorAll("select"):i.querySelectorAll(`input[type=${t}]`),this.validateGroupField(i,r,a,e,!0)}))}))}reevaluateGroupValidations(){[{attr:"data-check_validate",type:"checkbox"},{attr:"data-radio_validate",type:"radio"},{attr:"data-select_validate",type:"select"}].forEach((({attr:e,type:t})=>{this.form.querySelectorAll(`[${e}]`).forEach(((i,s)=>{const a=i.getAttribute("name")||i.getAttribute("id")||`${t}_group_${s}`;let r;r="select"===t?i.querySelectorAll("select"):i.querySelectorAll(`input[type=${t}]`),this.validateGroupField(i,r,a,e,!1)}))}))}setupGroupValidation(e,t,i,s){e.getAttribute("name")||e.getAttribute("id")||e.setAttribute("id",i);const a=this.isFieldInHiddenAreaInternal(e);this.log(`Setting up group validation for ${i}, isInHiddenArea: ${a}`),this.fieldStates.initializeField(i,e,{isTouched:!1,isValid:a,errors:[]},(e=>this.isFieldInHiddenAreaInternal(e))),t.forEach((a=>{a.addEventListener("change",(()=>{this.validateGroupField(e,t,i,s,!0)}))})),this.validateGroupField(e,t,i,s,!1)}validateGroupField(e,t,i,s,a=!1){if(this.isFieldInHiddenAreaInternal(e))return this.log(`Skipping group validation for hidden area: ${i}`),this.fieldStates.updateField(i,{isValid:!0,errors:[],isTouched:a}),this.errorDisplay.clearField(i),void this.updateCount();const r=e.getAttribute(s);let n=!1,l="";const o={"data-check_validate":{agree:"個人情報保護方針の同意にチェックを入れてください。",checkbox:"チェックボックスを選択してください。",default:"1つ以上選択してください"},"data-radio_validate":{radiobox:"ラジオボタンを選択してください。",default:"1つ以上選択してください"},"data-select_validate":{select:"選択してください。",default:"選択してください"}};if("data-check_validate"===s||"data-radio_validate"===s){if(n=Array.from(t).some((e=>e.checked)),!n){let e="";r&&r.includes("agree")?e=o["data-check_validate"].agree:"data-check_validate"===s?e=o["data-check_validate"].checkbox:"data-radio_validate"===s&&(e=o["data-radio_validate"].radiobox),l=e||o[s].default}}else"data-select_validate"===s&&(n=Array.from(t).some((e=>e.value)),n||(l=o["data-select_validate"].select));const d=this.fieldStates.getField(i);let u=d?.isTouched??!1;a&&(u=!0),this.fieldStates.updateField(i,{isValid:n,errors:n?[]:[{rule:"required",message:l,value:void 0}],isTouched:u}),!n&&u?this.errorDisplay.showFieldError(i,l,e):this.errorDisplay.clearField(i),this.updateCount()}}M.DEFAULT_OPTIONS={validation:{validateOnInput:!1,validateOnBlur:!0,debounceDelay:300},errorDisplay:{showOnValidation:!0,clearOnFocus:!0,animationDuration:200},onCountUpdated:function(e){var t=document.querySelector("[data-count_validate]");t&&(t.textContent=(e.total-e.valid).toString())}};class S{static init(e,t){const i=document.querySelector("form");if(!i)throw new Error("Form element not found");const s={...e,customMessages:{...e?.customMessages,...t},disableSubmitUntilValid:e?.disableSubmitUntilValid};return this.instance&&this.instance.destroy(),this.instance=new M(i,s),this.instance}static getInstance(){return this.instance}static update(){this.instance?this.instance.updateValidationCount():console.warn("[FormValidator] Instance not found. Please initialize first.")}static async check(){this.instance?await this.instance.validateAllFields():console.warn("[FormValidator] Instance not found. Please initialize first.")}}S.instance=null,S.PostalCodeValidator=m,S.TelValidator=f,S.EmailValidator=c,S.EmailConfirmValidator=h,S.TextValidator=g,S.RequiredValidator=u,S.BaseValidator=d,S.CustomValidator=p,S.CompositeValidator=class extends d{constructor(){super(...arguments),this.validators=[]}addValidator(e){return this.validators.push(e),this}async validate(e,t){let i=this.createSuccessResult();for(const s of this.validators){const a=await s.validate(e,t);a.isValid||(i=this.combineResults(i,a))}return i.isValid?await this.handleNext(e,t):i}},S.ConditionalValidator=class extends d{constructor(e,t){super(),this.condition=e,this.validator=t}async validate(e,t){try{if(await this.condition(e,t)){const i=await this.validator.validate(e,t);if(!i.isValid)return i}return await this.handleNext(e,t)}catch(t){const i=`条件チェックエラー: ${t}`;return this.createFailureResult([this.createError("conditional-error",i,e)])}}},"undefined"!=typeof window&&(window.FormValidator=S,window.FormManager=M);return t=t.FormValidator})()));